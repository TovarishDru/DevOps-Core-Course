name: Python CI

on:
    push:
        paths:
            - "app_python/**"
            - ".github/workflows/python-ci.yml"
    pull_request:
        paths:
            - "app_python/**"

jobs:
    test:
        runs-on: ubuntu-latest

        steps:
            - uses: actions/checkout@v4

            - uses: actions/setup-python@v5
              with:
                python-version: "3.11"
                cache: "pip"

            - name: Install deps
              run: |
                pip install -r app_python/requirements.txt
                pip install -r app_python/requirements-dev.txt

            - name: Lint (ruff)
              run: ruff check app_python

            - name: Run tests
              run: pytest app_python --cov=app_python --cov-report=term

            - name: Snyk scan
              uses: snyk/actions/python@master
              env:
                SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
              with:
                severity-threshold: high
                args: app_python --file=requirements.txt --skip-unresolved

    docker:
        needs: test
        runs-on: ubuntu-latest

        steps:
            - uses: actions/checkout@v4

            - uses: docker/login-action@v3
              with:
                username: ${{ secrets.DOCKERHUB_USERNAME }}
                password: ${{ secrets.DOCKERHUB_TOKEN }}

            - name: Set version (CalVer)
              run: echo "VERSION=$(date +%Y.%m)" >> $GITHUB_ENV

            - uses: docker/build-push-action@v6
              with:
                context: ./app_python
                push: true
                tags: |
                    ${{ secrets.DOCKERHUB_USERNAME }}/app:${{ env.VERSION }}
                    ${{ secrets.DOCKERHUB_USERNAME }}/app:latest
